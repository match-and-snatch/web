class Dashboard::Admin::BansController < Dashboard::Admin::BaseController
  before_action :load_user!, only: %i[destroy unsubscribe delete_profile_page restore_profile_page]
  before_action :load_counters, only: %i[index show]

  def index
    @users = users_query.page(params[:page]).per(100)
    json_render
  end

  def show
    q = params[:id] == 'unspecified' ? nil : params[:id]
    t = User.arel_table
    @users = users_query.where(t[:lock_type].eq(q).or(t[:lock_reason].eq(q))).page(params[:page]).per(100)
    json_render template: :index
  end

  def search
    @users = Queries::Users.new(user: current_user.object, query: params[:q]).by_admin_fields
    json_replace
  end

  def create
    UserManager.new(User.where(email: params[:email]).first).lock(type: params[:type])
    json_reload
  end

  def destroy
    UserManager.new(@user).unlock
    json_reload
  end

  def unsubscribe
    SubscriptionManager.new(subscriber: @user).unsubscribe_entirely
    json_reload
  end

  def delete_profile_page
    UserProfileManager.new(@user).delete_profile_page

    if @user.has_profile_page?
      json_reload notice: "Profile page removal requested for #{@user.name}"
    else
      json_reload notice: "Profile page has been removed for #{@user.name}"
    end
  end

  def restore_profile_page
    UserProfileManager.new(@user).create_profile_page
    json_reload
  end

  private

  def load_counters
    @counters = User.where(locked: true).group(:lock_type).count.merge(User.where(locked: true).group(:lock_reason).count)
    @counters['unspecified'] = @counters.delete(nil)
  end

  def load_user!
    @user = User.where(id: params[:id]).first or error(404)
  end

  def users_query
    User.select("users.*, COUNT(subscriptions.id) as not_removed_subscriptions_count")
      .joins("LEFT OUTER JOIN subscriptions ON users.id = subscriptions.user_id AND subscriptions.removed = 'f' AND deleted_at IS NULL")
      .where(locked: true)
      .group('users.id')
      .order(last_time_locked_at: :desc)
  end
end
