require 'spec_helper'

transloadit_data = {"transloadit"=>"{\"ok\":\"ASSEMBLY_COMPLETED\",\"message\":\"The assembly was successfully completed.\",\"assembly_id\":\"c3d12270ca0f11e3978149afb373c5be\",\"parent_id\":null,\"assembly_url\":\"http://api2.jaying.transloadit.com/assemblies/c3d12270ca0f11e3978149afb373c5be\",\"bytes_received\":819539,\"bytes_expected\":819539,\"client_agent\":\"Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36\",\"client_ip\":\"80.64.83.135\",\"client_referer\":\"http://localhost:3001/serg\",\"start_date\":\"2014/04/22 11:18:02 GMT\",\"is_infinite\":false,\"has_dupe_jobs\":false,\"upload_duration\":2.595,\"execution_start\":\"2014/04/22 11:18:04 GMT\",\"execution_duration\":7.771,\"notify_start\":null,\"notify_url\":null,\"notify_status\":null,\"last_job_completed\":\"2014/04/22 11:18:12 GMT\",\"notify_duration\":null,\"fields\":{\"slug\":\"serg\"},\"running_jobs\":[],\"bytes_usage\":2063557,\"executing_jobs\":[],\"started_jobs\":[],\"files_to_store_on_s3\":0,\"queued_files_to_store_on_s3\":0,\"parent_assembly_status\":null,\"params\":\"{\\\"steps\\\":{\\\"files\\\":{\\\"robot\\\":\\\"/file/filter\\\",\\\"accepts\\\":[[\\\"${file.mime}\\\",\\\"regex\\\",\\\"video\\\"]],\\\"error_on_decline\\\":true},\\\"thumbs\\\":{\\\"use\\\":\\\":original\\\",\\\"robot\\\":\\\"/video/thumbs\\\",\\\"count\\\":1},\\\"s3_thumb\\\":{\\\"robot\\\":\\\"/s3/store\\\",\\\"key\\\":\\\"****\\\",\\\"secret\\\":\\\"****\\\",\\\"use\\\":\\\"thumbs\\\",\\\"bucket\\\":\\\"buddy-assets\\\",\\\"path\\\":\\\"uploads/thumbs/${fields.slug}/${assembly.id}____${file.url_name}\\\"},\\\"encode\\\":{\\\"robot\\\":\\\"/video/encode\\\",\\\"use\\\":\\\":original\\\",\\\"ffmpeg_stack\\\":\\\"v2.0.0\\\",\\\"preset\\\":\\\"ipad\\\",\\\"width\\\":null,\\\"height\\\":null,\\\"ffmpeg\\\":{\\\"b\\\":\\\"700k\\\",\\\"vf\\\":\\\"scale='min(iw,1280)':-1\\\"}},\\\"store\\\":{\\\"robot\\\":\\\"/s3/store\\\",\\\"key\\\":\\\"****\\\",\\\"secret\\\":\\\"****\\\",\\\"use\\\":[\\\"encode\\\",\\\":original\\\"],\\\"url_prefix\\\":\\\"s1y5uslj4plb.cloudfront.net/\\\",\\\"bucket\\\":\\\"buddy-video-assets\\\",\\\"path\\\":\\\"${assembly.id}__${file.id}____${file.url_name}\\\"}}}\",\"uploads\":[{\"id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"name\":\"test_video1.mp4\",\"basename\":\"test_video1\",\"ext\":\"mp4\",\"size\":818086,\"mime\":\"video/mp4\",\"type\":\"video\",\"field\":\"post_videos\",\"md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"original_id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"original_basename\":\"test_video1\",\"original_md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"url\":\"http://tmp.jaying.transloadit.com/upload/bbe04fba1498ebe89f309906e69a01aa.mp4\",\"meta\":{\"duration\":10.29,\"width\":480,\"height\":360,\"framerate\":30,\"video_bitrate\":214160,\"overall_bitrate\":636024,\"video_codec\":\"ffh264\",\"audio_bitrate\":90552,\"audio_samplerate\":44100,\"audio_channels\":2,\"audio_codec\":\"ffaac\",\"seekable\":true,\"date_recorded\":null,\"date_file_created\":\"2009/03/02 14:54:28\",\"date_file_modified\":\"2014/04/22 11:18:03 GMT\",\"device_vendor\":null,\"device_name\":null,\"device_software\":null,\"latitude\":null,\"longitude\":null,\"rotation\":0,\"album\":null,\"comment\":null,\"year\":null}}],\"last_seq\":5,\"results\":{\"files\":[{\"id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"name\":\"test_video1.mp4\",\"basename\":\"test_video1\",\"ext\":\"mp4\",\"size\":818086,\"mime\":\"video/mp4\",\"type\":\"video\",\"field\":\"post_videos\",\"md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"original_id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"original_basename\":\"test_video1\",\"original_md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"url\":\"http://tmp.transloadit.com.s3.amazonaws.com/c58b0770ca0f11e3816b1d6c4b95fef4.mp4\",\"meta\":{\"duration\":10.29,\"width\":480,\"height\":360,\"framerate\":30,\"video_bitrate\":214160,\"overall_bitrate\":636024,\"video_codec\":\"ffh264\",\"audio_bitrate\":90552,\"audio_samplerate\":44100,\"audio_channels\":2,\"audio_codec\":\"ffaac\",\"seekable\":true,\"date_recorded\":null,\"date_file_created\":\"2009/03/02 14:54:28\",\"date_file_modified\":\"2014/04/22 11:18:03 GMT\",\"device_vendor\":null,\"device_name\":null,\"device_software\":null,\"latitude\":null,\"longitude\":null,\"rotation\":0,\"album\":null,\"comment\":null,\"year\":null}}],\":original\":[{\"id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"name\":\"test_video1.mp4\",\"basename\":\"test_video1\",\"ext\":\"mp4\",\"size\":818086,\"mime\":\"video/mp4\",\"type\":\"video\",\"field\":\"post_videos\",\"md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"original_id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"original_basename\":\"test_video1\",\"original_md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"url\":\"s1y5uslj4plb.cloudfront.net/c3d12270ca0f11e3978149afb373c5be__c58b0770ca0f11e3816b1d6c4b95fef4____test_video1.mp4\",\"meta\":{\"duration\":10.29,\"width\":480,\"height\":360,\"framerate\":30,\"video_bitrate\":214160,\"overall_bitrate\":636024,\"video_codec\":\"ffh264\",\"audio_bitrate\":90552,\"audio_samplerate\":44100,\"audio_channels\":2,\"audio_codec\":\"ffaac\",\"seekable\":true,\"date_recorded\":null,\"date_file_created\":\"2009/03/02 14:54:28\",\"date_file_modified\":\"2014/04/22 11:18:03 GMT\",\"device_vendor\":null,\"device_name\":null,\"device_software\":null,\"latitude\":null,\"longitude\":null,\"rotation\":0,\"album\":null,\"comment\":null,\"year\":null},\"ssl_url\":\"https://s1y5uslj4plb.cloudfront.net/c3d12270ca0f11e3978149afb373c5be__c58b0770ca0f11e3816b1d6c4b95fef4____test_video1.mp4\"}],\"thumbs\":[{\"id\":\"c6c953d0ca0f11e3b1d3ddbc44dc8502\",\"name\":\"test_video1.jpg\",\"basename\":\"test_video1\",\"ext\":\"jpg\",\"size\":12633,\"mime\":\"image/jpeg\",\"type\":\"image\",\"field\":\"post_videos\",\"md5hash\":\"2c7eabde1555c0a08751e5c88497cda0\",\"original_id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"original_basename\":\"test_video1\",\"original_md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"url\":\"http://buddy-assets.s3.amazonaws.com/uploads/thumbs/serg/c3d12270ca0f11e3978149afb373c5be____test_video1.jpg\",\"meta\":{\"duration\":10.29,\"width\":480,\"height\":360,\"framerate\":30,\"video_bitrate\":214160,\"overall_bitrate\":636024,\"video_codec\":\"ffh264\",\"audio_bitrate\":90552,\"audio_samplerate\":44100,\"audio_channels\":2,\"audio_codec\":\"ffaac\",\"seekable\":true,\"date_recorded\":null,\"date_file_created\":null,\"date_file_modified\":\"2014/04/22 11:18:06 GMT\",\"device_vendor\":null,\"device_name\":null,\"device_software\":null,\"latitude\":null,\"longitude\":null,\"rotation\":0,\"album\":null,\"comment\":null,\"year\":null,\"thumb_index\":0,\"thumb_offset\":5.145,\"title\":null,\"description\":null,\"location\":null,\"aspect_ratio\":1.3333333333333333,\"city\":null,\"state\":null,\"country\":null,\"country_code\":null,\"keywords\":null,\"aperture\":null,\"exposure_compensation\":null,\"exposure_mode\":null,\"exposure_time\":null,\"flash\":null,\"focal_length\":null,\"f_number\":null,\"iso\":null,\"light_value\":null,\"metering_mode\":null,\"shutter_speed\":null,\"white_balance\":null,\"orientation\":null,\"has_clipping_path\":false,\"creator\":null,\"author\":null,\"copyright\":null,\"copyright_notice\":null,\"frame_count\":1},\"ssl_url\":\"https://buddy-assets.s3.amazonaws.com/uploads/thumbs/serg/c3d12270ca0f11e3978149afb373c5be____test_video1.jpg\"}],\"encode\":[{\"id\":\"c6d1df50ca0f11e3aa5205b417138140\",\"name\":\"test_video1.mp4\",\"basename\":\"test_video1\",\"ext\":\"mp4\",\"size\":1080590,\"mime\":\"video/mp4\",\"type\":\"video\",\"field\":\"post_videos\",\"md5hash\":\"be7993024a884bd584f7b3ce71723a0c\",\"original_id\":\"c58b0770ca0f11e3816b1d6c4b95fef4\",\"original_basename\":\"test_video1\",\"original_md5hash\":\"da9725443e8ff4ab10c02cca5a3766bf\",\"url\":\"s1y5uslj4plb.cloudfront.net/c3d12270ca0f11e3978149afb373c5be__c6d1df50ca0f11e3aa5205b417138140____test_video1.mp4\",\"meta\":{\"duration\":10.4,\"width\":480,\"height\":360,\"framerate\":25,\"video_bitrate\":696864,\"overall_bitrate\":831223,\"video_codec\":\"ffh264\",\"audio_bitrate\":128040,\"audio_samplerate\":48000,\"audio_channels\":2,\"audio_codec\":\"ffaac\",\"seekable\":true,\"date_recorded\":null,\"date_file_created\":\"1904/01/01 00:00:00\",\"date_file_modified\":\"2014/04/22 11:18:08 GMT\",\"device_vendor\":\"Apple\",\"device_name\":null,\"device_software\":null,\"latitude\":null,\"longitude\":null,\"rotation\":0,\"album\":null,\"comment\":null,\"year\":null},\"ssl_url\":\"https://s1y5uslj4plb.cloudfront.net/c3d12270ca0f11e3978149afb373c5be__c6d1df50ca0f11e3aa5205b417138140____test_video1.mp4\"}]}}", "params"=>"{\"steps\":{\"files\":{\"robot\":\"/file/filter\",\"accepts\":[[\"${file.mime}\",\"regex\",\"video\"]],\"error_on_decline\":true},\"thumbs\":{\"use\":\":original\",\"robot\":\"/video/thumbs\",\"count\":1},\"s3_thumb\":{\"robot\":\"/s3/store\",\"key\":\"AKIAJ5KUIYFXQB5KUD5A\",\"secret\":\"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\",\"use\":\"thumbs\",\"bucket\":\"buddy-assets\",\"path\":\"uploads/thumbs/${fields.slug}/${assembly.id}____${file.url_name}\"},\"encode\":{\"robot\":\"/video/encode\",\"use\":\":original\",\"ffmpeg_stack\":\"v2.0.0\",\"preset\":\"ipad\",\"width\":null,\"height\":null,\"ffmpeg\":{\"b\":\"700k\",\"vf\":\"scale='min(iw,1280)':-1\"}},\"store\":{\"robot\":\"/s3/store\",\"key\":\"AKIAJ5KUIYFXQB5KUD5A\",\"secret\":\"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\",\"use\":[\"encode\",\":original\"],\"url_prefix\":\"s1y5uslj4plb.cloudfront.net/\",\"bucket\":\"buddy-video-assets\",\"path\":\"${assembly.id}__${file.id}____${file.url_name}\"}},\"auth\":{\"key\":\"6742a710a9ab11e3a661690b776b09a8\",\"expires\":\"2014/04/22 11:47:52+00:00\"}}", "signature"=>"2a1758fa13c2968fefbed36d5b008b9fd55f1732", "post_videos"=>"", "slug"=>"serg", "authenticity_token"=>"quOFW+WseZBbTN3eZLHGNbyABHpqL38V8CgTOUIIXrQ="}

describe VideosController do
  let(:owner) { create_user email: 'owner@gmail.com', is_profile_owner: true }
  describe 'POST #create' do
    subject { post 'create', transloadit_data }

    context 'unauthorized access' do
      its(:status) { should == 401 }
    end

    context 'authorized access' do
      before { sign_in owner }
      its(:status) { should == 200 }
    end
  end

  describe 'DELETE #destroy' do
    let(:video_upload) { create_video_upload  owner, transloadit: JSON.parse(transloadit_data['transloadit'])  }
    subject { delete 'destroy', id: video_upload.id }

    context 'unauthorized access' do
      its(:status) { should == 401 }
    end

    context 'authorized access' do
      before { sign_in owner }
      its(:status) { should == 200 }
    end
  end
end